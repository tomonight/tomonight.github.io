<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="“redis从入门到放弃”"/>








  <link rel="alternate" href="/default" title="tomonight" >




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="http://tomonight.top/2022/08/26/“redis从入门到放弃”/"/>


<meta name="description" content="redis从入门到放弃1.什么是redis内存数据库， kv数据库，多数据结构数据库(string,list,set,zset,hash) 12345Redis 是一个开源（BSD 许可）的内存数据结构存储，用作数据库、缓存、消息代理和流引擎。Redis 提供数据结构，例如 字符串、散列、列表、集合、带范围查询的排序集合、位图、超日志、地理空间索引和流。Redis 内置了复制、Lua 脚本、LRU">
<meta property="og:type" content="article">
<meta property="og:title" content="“redis从入门到放弃”">
<meta property="og:url" content="http://tomonight.top/2022/08/26/%E2%80%9Credis%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83%E2%80%9D/index.html">
<meta property="og:site_name" content="tomonight">
<meta property="og:description" content="redis从入门到放弃1.什么是redis内存数据库， kv数据库，多数据结构数据库(string,list,set,zset,hash) 12345Redis 是一个开源（BSD 许可）的内存数据结构存储，用作数据库、缓存、消息代理和流引擎。Redis 提供数据结构，例如 字符串、散列、列表、集合、带范围查询的排序集合、位图、超日志、地理空间索引和流。Redis 内置了复制、Lua 脚本、LRU">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://tomonight.top/redis/redis_3.png">
<meta property="og:image" content="http://tomonight.top/redis/redis_vs_memcached.png">
<meta property="og:image" content="http://tomonight.top/redis/five_type.png">
<meta property="article:published_time" content="2022-08-26T01:56:33.000Z">
<meta property="article:modified_time" content="2022-08-29T02:37:13.351Z">
<meta property="article:author" content="tomonight">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://tomonight.top/redis/redis_3.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> “redis从入门到放弃” - tomonight </title>
  <meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">tomonight</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          “redis从入门到放弃”
        
      </h1>

      <time class="post-time">
          Aug 26 2022
      </time>
    </header>



    
            <div class="post-content">
            <h1 id="redis从入门到放弃"><a href="#redis从入门到放弃" class="headerlink" title="redis从入门到放弃"></a>redis从入门到放弃</h1><h2 id="1-什么是redis"><a href="#1-什么是redis" class="headerlink" title="1.什么是redis"></a>1.什么是redis</h2><p>内存数据库， kv数据库，多数据结构数据库(string,list,set,zset,hash)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Redis 是一个开源（BSD 许可）的内存数据结构存储，用作数据库、缓存、消息代理和流引擎。</span><br><span class="line">Redis 提供数据结构，例如 字符串、散列、列表、集合、带范围查询的排序集合、位图、超日志、地理空间索引和流。</span><br><span class="line">Redis 内置了复制、Lua 脚本、LRU 驱逐、事务和不同级别的磁盘持久性，并通过Redis Sentinel和Redis Cluster自动分区提供高可用性。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="2-redis总览"><a href="#2-redis总览" class="headerlink" title="2.redis总览"></a>2.redis总览</h2><h3 id="2-1-单线程"><a href="#2-1-单线程" class="headerlink" title="2.1 单线程"></a>2.1 单线程</h3><p>Redis 单线程指的是「接收客户端请求-&gt;解析请求 -&gt;进行数据读写等操作-&gt;发送数据给客户端」这个过程是由一个线程（主线程）来完成的，这也是我们常说 Redis 是单线程的原因。<br>其他线程：<br>BIO_CLOSE_FILE，关闭文件任务队列：当队列有任务后，后台线程会调用 close(fd) ，将文件关闭<br>BIO_AOF_FSYNC，AOF刷盘任务队列：当 AOF 日志配置成 everysec 选项后，主线程会把 AOF 写日志操作封装成一个任务，也放到队列中。当发现队列有任务后，后台线程会调用 fsync(fd)，将 AOF 文件刷盘<br>BIO_LAZY_FREE，lazy free 任务队列：当队列有任务后，后台线程会 free(obj) 释放对象 &#x2F; free(dict) 删除数据库所有对象 &#x2F; free(skiplist) 释放跳表对象</p>
<p>redis 6.0后的版本：<br>虽然 Redis 的主要工作（网络 I&#x2F;O 和执行命令）一直是单线程模型，但是在 Redis 6.0 版本之后，也采用了多个 I&#x2F;O 线程来处理网络请求，这是因为随着网络硬件的性能提升，Redis 的性能瓶颈有时会出现在网络 I&#x2F;O 的处理上。</p>
<p>所以为了提高网络 I&#x2F;O 的并行度，Redis 6.0 对于网络 I&#x2F;O 采用多线程来处理。但是对于命令的执行，Redis 仍然使用单线程来处理，所以大家不要误解 Redis 有多线程同时执行命令。</p>
<p>Redis 官方表示，Redis 6.0 版本引入的多线程 I&#x2F;O 特性对性能提升至少是一倍以上。</p>
<p>Redis 6.0 版本支持的 I&#x2F;O 多线程特性，默认情况下 I&#x2F;O 多线程只针对发送响应数据（write client socket），并不会以多线程的方式处理读请求（read client socket）。要想开启多线程处理客户端读请求，就需要把 Redis.conf 配置文件中的 io-threads-do-reads 配置项设为 yes。</p>
<h3 id="2-2-高性能"><a href="#2-2-高性能" class="headerlink" title="2.2 高性能"></a>2.2 高性能</h3><p><img src="/redis/redis_3.png" alt="redis"></p>
<p>单台设备的 Redis 的 QPS（Query Per Second，每秒钟处理完请求的次数） 是 MySQL 的 10 倍，Redis 单机的 QPS 能轻松破 10w，而 MySQL 单机的 QPS 很难破 1w。</p>
<p>所以，直接访问 Redis 能够承受的请求是远远大于直接访问 MySQL 的，所以我们可以考虑把数据库中的部分数据转移到缓存中去，这样用户的一部分请求会直接到缓存这里而不用经过数据库。</p>
<h3 id="2-3-持久化"><a href="#2-3-持久化" class="headerlink" title="2.3 持久化"></a>2.3 持久化</h3><p>AOF 日志：每执行一条写操作命令，就把该命令以追加的方式写入到一个文件里；<br>RDB 快照：将某一时刻的内存数据，以二进制的方式写入磁盘；<br>混合持久化方式：Redis 4.0 新增的方式，集成了 AOF 和 RBD 的优点；</p>
<h4 id="2-3-1-AOF-日志"><a href="#2-3-1-AOF-日志" class="headerlink" title="2.3.1 AOF 日志"></a>2.3.1 AOF 日志</h4><p>Redis 在执行完一条写操作命令后，就会把该命令以追加的方式写入到一个文件里，然后 Redis 重启时，会读取该文件记录的命令，然后逐一执行命令的方式来进行数据恢复。</p>
<h3 id="2-4-和memcache对比"><a href="#2-4-和memcache对比" class="headerlink" title="2.4 和memcache对比"></a>2.4 和memcache对比</h3><p><img src="/redis/redis_vs_memcached.png" alt="redis"></p>
<p>Redis 支持的数据类型更丰富（String、Hash、List、Set、ZSet），而 Memcached 只支持最简单的 key-value 数据类型；<br>Redis 支持数据的持久化，可以将内存中的数据保持在磁盘中，重启的时候可以再次加载进行使用，而 Memcached 没有持久化功能，数据全部存在内存之中，Memcached 重启或者挂掉后，数据就没了；<br>Redis 原生支持集群模式，Memcached 没有原生的集群模式，需要依靠客户端来实现往集群中分片写入数据；<br>Redis 支持发布订阅模型、Lua 脚本、事务等功能，而 Memcached 不支持；<br>#</p>
<h2 id="3-redis数据结构"><a href="#3-redis数据结构" class="headerlink" title="3.redis数据结构"></a>3.redis数据结构</h2><p>· String 类型的应用场景：缓存对象、常规计数、分布式锁、共享 session 信息等。<br>· List 类型的应用场景：消息队列（但是有两个问题：1. 生产者需要自行实现全局唯一 ID；2. 不能以消费组形式消费数据）等。<br>· Hash 类型：缓存对象、购物车等。<br>· Set 类型：聚合计算（并集、交集、差集）场景，比如点赞、共同关注、抽奖活动等。<br>· Zset 类型：排序场景，比如排行榜、电话和姓名排序等。</p>
<p><img src="/redis/five_type.png" alt="redis"></p>
<p><a target="_blank" rel="noopener" href="https://redis.com/ebook/part-1-getting-started/chapter-1-getting-to-know-redis/1-2-what-redis-data-structures-look-like/">https://redis.com/ebook/part-1-getting-started/chapter-1-getting-to-know-redis/1-2-what-redis-data-structures-look-like/</a></p>
<h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><p>原文：<br><a target="_blank" rel="noopener" href="https://redis.com/ebook/part-1-getting-started/chapter-1-getting-to-know-redis/1-2-what-redis-data-structures-look-like/1-2-1-strings-in-redis/">https://redis.com/ebook/part-1-getting-started/chapter-1-getting-to-know-redis/1-2-what-redis-data-structures-look-like/1-2-1-strings-in-redis/</a></p>
<p>SDS：简单动态字符串</p>
<p>SDS 不仅可以保存文本数据，还可以保存二进制数据。因为 SDS 使用 len 属性的值而不是空字符来判断字符串是否结束，并且 SDS 的所有 API 都会以处理二进制的方式来处理 SDS 存放在 buf[] 数组里的数据。所以 SDS 不光能存放文本数据，而且能保存图片、音频、视频、压缩文件这样的二进制数据。<br>SDS 获取字符串长度的时间复杂度是 O(1)。因为 C 语言的字符串并不记录自身长度，所以获取长度的复杂度为 O(n)；而 SDS 结构里用 len 属性记录了字符串长度，所以复杂度为 O(1)。<br>Redis 的 SDS API 是安全的，拼接字符串不会造成缓冲区溢出。因为 SDS 在拼接字符串之前会检查 SDS 空间是否满足要求，如果空间不够会自动扩容，所以不会导致缓冲区溢出的问题。</p>
<p>源码位置：sds.c sdsalloc.c</p>
<h2 id="4-过期策略"><a href="#4-过期策略" class="headerlink" title="4. 过期策略"></a>4. 过期策略</h2><h3 id="4-1-惰性策略"><a href="#4-1-惰性策略" class="headerlink" title="4.1 惰性策略"></a>4.1 惰性策略</h3><h3 id="4-2-定期策略"><a href="#4-2-定期策略" class="headerlink" title="4.2 定期策略"></a>4.2 定期策略</h3><h3 id="4-3-LRU（-amp-LFU）算法"><a href="#4-3-LRU（-amp-LFU）算法" class="headerlink" title="4.3 LRU（&amp;LFU）算法"></a>4.3 LRU（&amp;LFU）算法</h3><h2 id="5-redis缓存"><a href="#5-redis缓存" class="headerlink" title="5. redis缓存"></a>5. redis缓存</h2><h3 id="5-1-缓存雪崩、缓存击穿、缓存穿透"><a href="#5-1-缓存雪崩、缓存击穿、缓存穿透" class="headerlink" title="5.1 缓存雪崩、缓存击穿、缓存穿透"></a>5.1 缓存雪崩、缓存击穿、缓存穿透</h3><h3 id="5-2-更新策略"><a href="#5-2-更新策略" class="headerlink" title="5.2 更新策略"></a>5.2 更新策略</h3><h3 id="5-3-缓存一致性问题"><a href="#5-3-缓存一致性问题" class="headerlink" title="5.3 缓存一致性问题"></a>5.3 缓存一致性问题</h3><h2 id="6-redis集群"><a href="#6-redis集群" class="headerlink" title="6 redis集群"></a>6 redis集群</h2><h3 id="6-1-主从"><a href="#6-1-主从" class="headerlink" title="6.1 主从"></a>6.1 主从</h3><h3 id="6-2-哨兵"><a href="#6-2-哨兵" class="headerlink" title="6.2 哨兵"></a>6.2 哨兵</h3><h3 id="6-3-切片集群"><a href="#6-3-切片集群" class="headerlink" title="6.3 切片集群"></a>6.3 切片集群</h3>
            </div>
          

    
      <footer class="post-footer">
		

        
        
  <nav class="post-nav">
    
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2022
    <span class="footer-author">tomonight.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> and <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
